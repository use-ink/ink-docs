"use strict";(self.webpackChunkink_docs=self.webpackChunkink_docs||[]).push([[4019],{22272:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"faq/migrating-from-ink-4-to-5","title":"Migrating from ink! 4.x to 5.0","description":"Migration 4.x To 5.0 Title Picture","source":"@site/docs/faq/migrating-from-ink-4-to-5.mdx","sourceDirName":"faq","slug":"/faq/migrating-from-ink-4-to-5","permalink":"/docs/v5/faq/migrating-from-ink-4-to-5","draft":false,"unlisted":false,"editUrl":"https://github.com/use-ink/ink-docs/edit/master/docs/faq/migrating-from-ink-4-to-5.mdx","tags":[],"version":"current","frontMatter":{"title":"Migrating from ink! 4.x to 5.0","slug":"/faq/migrating-from-ink-4-to-5"},"sidebar":"reference","previous":{"title":"Frequently Asked Questions","permalink":"/docs/v5/faq"},"next":{"title":"Migrating from ink! 3.x to 4.0","permalink":"/docs/v5/faq/migrating-from-ink-3-to-4"}}');var s=t(74848),a=t(28453),c=t(29030);const r={title:"Migrating from ink! 4.x to 5.0",slug:"/faq/migrating-from-ink-4-to-5"},o=void 0,l={},d=[{value:"How to upgrade",id:"how-to-upgrade",level:2},{value:"Compatibility",id:"compatibility",level:2},{value:"Substrate/Polkadot SDK",id:"substratepolkadot-sdk",level:3},{value:"How do I find out if a chain is compatible with ink! 5?",id:"how-do-i-find-out-if-a-chain-is-compatible-with-ink-5",level:3},{value:"<code>cargo-contract</code> 4.0",id:"cargo-contract-40",level:3},{value:"Tooling &amp; Libraries",id:"tooling--libraries",level:3},{value:"Important Changes",id:"important-changes",level:2},{value:"<code>scale</code> dependencies were moved to <code>ink</code> entrance crate",id:"scale-dependencies-were-moved-to-ink-entrance-crate",level:3},{value:"Wildcard selectors: only one other message is allowed in the contract besides the wildcard selector",id:"wildcard-selectors-only-one-other-message-is-allowed-in-the-contract-besides-the-wildcard-selector",level:3},{value:"Events 2.0",id:"events-20",level:3},{value:"Custom signature topics",id:"custom-signature-topics",level:4},{value:"No more unchecked arithmetic",id:"no-more-unchecked-arithmetic",level:3},{value:"Fail when decoding from storage and not all bytes consumed",id:"fail-when-decoding-from-storage-and-not-all-bytes-consumed",level:3},{value:"[ink_e2e] API Changes",id:"ink_e2e-api-changes",level:3},{value:"Builder API",id:"builder-api",level:4},{value:"Extra gas margin",id:"extra-gas-margin",level:4},{value:"Improved <code>call()</code> API",id:"improved-call-api",level:4},{value:"Removed <code>additional_contracts</code> parameter",id:"removed-additional_contracts-parameter",level:4},{value:"New Data Structure: <code>StorageVec</code>",id:"new-data-structure-storagevec",level:3},{value:"Fallible methods for <code>Lazy</code>, <code>Mapping</code>, <code>StorageVec</code>",id:"fallible-methods-for-lazy-mapping-storagevec",level:3},{value:"Chain Extension API changed + Support for multiple chain extensions",id:"chain-extension-api-changed--support-for-multiple-chain-extensions",level:3},{value:"<code>call</code> and <code>instantiate</code> v2",id:"call-and-instantiate-v2",level:3},{value:"Metadata Changes",id:"metadata-changes",level:3},{value:"Events 2.0",id:"events-20-1",level:4},{value:"New field: <code>staticBufferSize</code>",id:"new-field-staticbuffersize",level:4},{value:"Metadata storage keys encoding change",id:"metadata-storage-keys-encoding-change",level:4},{value:"Interesting New Features",id:"interesting-new-features",level:2},{value:"End-To-End testing with a chain snapshot",id:"end-to-end-testing-with-a-chain-snapshot",level:3},{value:"New lints",id:"new-lints",level:3},{value:"New <code>cargo-contract</code> commands",id:"new-cargo-contract-commands",level:3},{value:"Alternative off-chain E2E testing backend support: DRink!",id:"alternative-off-chain-e2e-testing-backend-support-drink",level:3},{value:"Contract Verification",id:"contract-verification",level:3},{value:"We improved the contract example illustrating upgradeable contracts via <code>delegate_call</code>",id:"we-improved-the-contract-example-illustrating-upgradeable-contracts-via-delegate_call",level:3},{value:"Upgradeable Contracts: <code>delegate_dependency</code>",id:"upgradeable-contracts-delegate_dependency",level:3},{value:"We made <code>set_code_hash</code> generic",id:"we-made-set_code_hash-generic",level:3},{value:"Buffer size can be customized",id:"buffer-size-can-be-customized",level:3},{value:"Stabilized <code>call_runtime</code>",id:"stabilized-call_runtime",level:3}];function h(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Migration 4.x To 5.0 Title Picture",src:t(36048).A+"",width:"1600",height:"500"})}),"\n",(0,s.jsx)(n.p,{children:"We've made a couple of breaking changes from ink! 4.x to ink! 5.0.\nOn this page we outline how you can migrate existing dApps and\ncontracts from 4.x to 5.0."}),"\n",(0,s.jsxs)(n.p,{children:["This release addresses the majority of issues raised in ",(0,s.jsx)(n.a,{href:"https://blog.openzeppelin.com/security-review-ink-cargo-contract",children:"the OpenZeppelin\nsecurity review"}),".\nIn particular, we addressed the proxy selector clashing attack."]}),"\n",(0,s.jsxs)(n.p,{children:["You can find the full changelog of the 5.0 release ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/blob/master/CHANGELOG.md#version-500",children:"here"}),"."]}),"\n",(0,s.jsxs)(n.admonition,{type:"caution",children:[(0,s.jsx)(n.p,{children:"This migration guide only considers your code base! Not your storage data!"}),(0,s.jsx)(n.p,{children:"If you have an existing contract on-chain you might not be able to just\nupgrade the code on-chain, you possibly also have to migrate your storage data."}),(0,s.jsxs)(n.p,{children:["The relevant change that you have to take into consideration is\n",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1897",children:"#1897"}),".\nA data migration may be required when your contract reads data from storage and truncates\nthe data when decoding it.\nWe've described this in more detail below, in the section\n",(0,s.jsx)(n.a,{href:"#fail-when-decoding-from-storage-and-not-all-bytes-consumed",children:'"Fail when decoding from storage and not all bytes consumed"'}),"."]})]}),"\n",(0,s.jsx)(n.h2,{id:"how-to-upgrade",children:"How to upgrade"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Change the dependency versions of ",(0,s.jsx)(n.code,{children:"ink"})," and ",(0,s.jsx)(n.code,{children:"ink_e2e"})," in your contracts ",(0,s.jsx)(n.code,{children:"Cargo.toml"})," to ",(0,s.jsx)(n.code,{children:"5"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Update your local ",(0,s.jsx)(n.code,{children:"cargo-contract"})," installation to 4.0."]}),"\n",(0,s.jsx)(n.li,{children:"Read through this page."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"compatibility",children:"Compatibility"}),"\n",(0,s.jsx)(n.h3,{id:"substratepolkadot-sdk",children:"Substrate/Polkadot SDK"}),"\n",(0,s.jsx)(n.p,{children:"There are four new functions that are only compatible from particular releases upwards:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["v2 of ",(0,s.jsx)(n.code,{children:"call"})," and ",(0,s.jsx)(n.code,{children:"instantiate"}),": ",(0,s.jsx)(n.code,{children:">= polkadot-v1.8.0"})," and ",(0,s.jsx)(n.code,{children:"substrate-contracts-node >= v0.39.0"}),"\n(",(0,s.jsx)(n.a,{href:"#call-and-instantiate-v2",children:"explained here"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"lock_delegate_dependency"})," and ",(0,s.jsx)(n.code,{children:"unlock_delegate_dependency"}),":\n",(0,s.jsx)(n.code,{children:">= polkadot-v1.9.0"})," and ",(0,s.jsx)(n.code,{children:"substrate-contracts-node >= v0.40.0"})," (",(0,s.jsx)(n.a,{href:"#upgradeable-contracts-delegate_dependency",children:"explained here"}),")."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"These four functions are all opt-in! None of them are required to use ink! 5.0, they are only\nrequired if you want to access the particular functionality they provide.\nPlease see the linked explainers for more details about them."}),"\n",(0,s.jsx)(n.p,{children:"If you are not using any of those four functions, the same requirements as for ink! 4.0 holds:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"pallet-contracts"})," >= ",(0,s.jsx)(n.code,{children:"polkadot-v0.9.37"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"substrate-contracts-node"})," >= ",(0,s.jsx)(n.code,{children:"v0.24.0"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"how-do-i-find-out-if-a-chain-is-compatible-with-ink-5",children:"How do I find out if a chain is compatible with ink! 5?"}),"\n",(0,s.jsxs)(n.p,{children:["You can query ",(0,s.jsx)(n.code,{children:"contracts::palletVersion()"})," via the chain state RPCs. It has to\nbe ",(0,s.jsx)(n.code,{children:">= 9"})," for ink! 5.0 to be compatible, if you don't use any of the four functions\nmentioned above.\nFor the above mentioned four functions please see the respective sections on this page,\nthere we explain how to find out if a chain supports them there."]}),"\n",(0,s.jsxs)(n.p,{children:["You can use the ",(0,s.jsx)(n.a,{href:"https://polkadot.js.org/apps/",children:"polakdot.js app"})," to do this:\nDeveloper \xbb Chain State \xbb ",(0,s.jsx)(n.code,{children:"contracts"})," \xbb ",(0,s.jsx)(n.code,{children:"palletVersion()"})," \xbb Click on the ",(0,s.jsx)(n.code,{children:"+"})," on the right."]}),"\n",(0,s.jsx)("img",{src:(0,c.Ay)("/img/pallet-version.png")}),"\n",(0,s.jsx)(n.p,{children:"The following chains are in production and support ink! 5.0, if you are not using any of the\nfour functions mentioned above:"}),"\n",(0,s.jsxs)("div",{className:"row",children:[(0,s.jsx)("div",{className:"col text--center",children:(0,s.jsx)("a",{href:"https://alephzero.org",children:(0,s.jsx)("img",{src:(0,c.Ay)("/img/chains/aleph-zero.svg"),className:"chain"})})}),(0,s.jsx)("div",{className:"col text--center",children:(0,s.jsx)("a",{href:"https://astar.network",children:(0,s.jsx)("img",{src:(0,c.Ay)("/img/chains/astar.svg"),className:"chain"})})}),(0,s.jsx)("div",{className:"col text--center",children:(0,s.jsx)("a",{href:"https://shiden.astar.network",children:(0,s.jsx)("img",{src:(0,c.Ay)("/img/chains/shiden.svg"),className:"chain"})})})]}),"\n",(0,s.jsxs)("div",{className:"row",children:[(0,s.jsx)("div",{className:"col text--center",children:(0,s.jsx)("a",{href:"http://phala.network",children:(0,s.jsx)("img",{src:(0,c.Ay)("/img/chains/phala.svg"),className:"chain"})})}),(0,s.jsx)("div",{className:"col text--center",children:(0,s.jsx)("a",{href:"https://pendulumchain.org",children:(0,s.jsx)("img",{src:(0,c.Ay)("/img/chains/pendulum.svg"),className:"chain"})})}),(0,s.jsx)("div",{className:"col text--center",children:(0,s.jsx)("a",{href:"https://pendulumchain.org/amplitude",children:(0,s.jsx)("img",{src:(0,c.Ay)("/img/chains/amplitude.svg"),className:"chain"})})})]}),"\n",(0,s.jsxs)("div",{className:"row",children:[(0,s.jsx)("div",{className:"col text--center",children:(0,s.jsx)("a",{href:"https://www.ternoa.network/",children:(0,s.jsx)("img",{src:(0,c.Ay)("/img/chains/ternoa.svg"),className:"chain"})})}),(0,s.jsx)("div",{className:"col text--center",children:(0,s.jsx)("a",{href:"https://krest.peaq.network/",children:(0,s.jsx)("img",{src:(0,c.Ay)("/img/chains/krest.svg"),className:"chain"})})})]}),"\n",(0,s.jsxs)(n.h3,{id:"cargo-contract-40",children:[(0,s.jsx)(n.code,{children:"cargo-contract"})," 4.0"]}),"\n",(0,s.jsxs)(n.p,{children:["Together with ink! 5.0 we've released ",(0,s.jsx)(n.code,{children:"cargo-contract"})," 4.0."]}),"\n",(0,s.jsxs)(n.admonition,{type:"info",children:[(0,s.jsxs)(n.p,{children:["You have to use ",(0,s.jsx)(n.code,{children:"cargo-contract"})," >= 4.0 for ink! 5.0 contracts!"]}),(0,s.jsx)(n.p,{children:"You can upgrade via:"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"cargo install cargo-contract --version ^4\n"})})]}),"\n",(0,s.jsxs)(n.p,{children:["Make sure that e.g. your CI also uses at least ",(0,s.jsx)(n.code,{children:"cargo-contract"})," 4.0 with ink! v5.0.\nIf you have wrapper scripts around ",(0,s.jsx)(n.code,{children:"cargo-contract"}),", you should\nensure that this version is enforced, otherwise users will get an error."]}),"\n",(0,s.jsx)(n.h3,{id:"tooling--libraries",children:"Tooling & Libraries"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Stable Rust >= 1.75"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"cargo-contract"})," >= v4.0"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"polkadot-js/api"})," and ",(0,s.jsx)(n.code,{children:"polkadot-js/api-contract"})," >= 10.12.1"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/scio-labs/use-inkathon",children:(0,s.jsx)(n.code,{children:"use-inkathon"})}),": upgrade the ",(0,s.jsx)(n.code,{children:"polkadot-js/api"})," and ",(0,s.jsx)(n.code,{children:"polkadot-js/api-contract"})," dependencies in your project to >= 10.12.1"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://inkathon.xyz/",children:"ink!athon"})," >= 0.7.0"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/Brushfam/typechain-polkadot",children:(0,s.jsx)(n.code,{children:"typechain-polkadot"})})," >= 1.2.0"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"important-changes",children:"Important Changes"}),"\n",(0,s.jsx)(n.p,{children:"We had to introduce a number of changes that require you to manually upgrade\nyour contract from 4.x to 5.0. The steps to do this are explained in this section."}),"\n",(0,s.jsxs)(n.h3,{id:"scale-dependencies-were-moved-to-ink-entrance-crate",children:[(0,s.jsx)(n.code,{children:"scale"})," dependencies were moved to ",(0,s.jsx)(n.code,{children:"ink"})," entrance crate"]}),"\n",(0,s.jsxs)(n.p,{children:["This change was done to ensure that you always use the correct scale dependency versions\nwith an ink! version. The relevant PR is ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1890",children:"#1890"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["We removed the requirement for contracts to have direct dependencies on ",(0,s.jsx)(n.code,{children:"parity-scale-codec"}),"\nand ",(0,s.jsx)(n.code,{children:"scale-info"})," in their ",(0,s.jsx)(n.code,{children:"Cargo.toml"}),".\nYou can now remove those dependencies from your contracts ",(0,s.jsx)(n.code,{children:"Cargo.toml"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",children:'ink = { version = "4.3", default-features = false }\n-scale = { package = "parity-scale-codec", version = "3", default-features = false, features = ["derive"] }\n-scale-info = { version = "2.6", default-features = false, features = ["derive"], optional = true }\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Both crates have been re-exported from the ",(0,s.jsx)(n.code,{children:"ink"})," umbrella crate: ",(0,s.jsx)(n.code,{children:"ink::scale_info"})," and ",(0,s.jsx)(n.code,{children:"ink::scale"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["We created a convenience macro to derive the re-exported traits ",(0,s.jsx)(n.code,{children:"ink::scale::Encode"}),",\n",(0,s.jsx)(n.code,{children:"ink::scale::Decode"})," and ",(0,s.jsx)(n.code,{children:"ink::scale_info::TypeInfo"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'// Previously\n#[scale::Encode, scale::Decode)]\n#[cfg_attr(feature = "std", derive(::scale_info::TypeInfo))]\npub enum Error {}\n\n\n// Now\n#[ink::scale_derive(Encode, Decode, TypeInfo)]\npub enum Error {}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["The documentation of the macro can be found ",(0,s.jsx)(n.a,{href:"https://docs.rs/ink/5.0.0/ink/attr.scale_derive.html",children:"here"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"wildcard-selectors-only-one-other-message-is-allowed-in-the-contract-besides-the-wildcard-selector",children:"Wildcard selectors: only one other message is allowed in the contract besides the wildcard selector"}),"\n",(0,s.jsxs)(n.p,{children:["Following ",(0,s.jsx)(n.a,{href:"https://blog.openzeppelin.com/security-review-ink-cargo-contract",children:"our security review by OpenZeppelin"}),",\nwe've tightened the usage of wildcard selectors.\nWith ink! 5.0 we allow only exactly one other contract message with a well-known reserved\nselector to be defined. In ink! 4.x, more than one other message was allowed."]}),"\n",(0,s.jsxs)(n.p,{children:["Read more in ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1708",children:"the PR"})," and ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/issues/1676",children:"IIP-2: Limit contracts with a wildcard selector to one other message"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"The proposal is to restrict contracts with a wildcard selector to only have one other message\nwith a reserved/well-known selector. This guarantees that there are no selector clashes,\neither by chance or malicious intent, and that the Proxy will only handle messages intended for it."}),"\n",(0,s.jsxs)(n.p,{children:["If a contract uses a wildcard selector ",(0,s.jsx)(n.code,{children:"#[ink(message, payable, selector = _)]"})," it ",(0,s.jsx)(n.em,{children:"MAY"})," define one\nother message. This message ",(0,s.jsx)(n.em,{children:"MUST"})," use the reserved selector ",(0,s.jsx)(n.code,{children:"@"}),".\nThis selector ",(0,s.jsx)(n.em,{children:"MUST"})," only be used in conjunction with a wildcard selector."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'/// Handles any message with no matching selector in this proxy contract\n#[ink(message, selector = _)]\npub fn fallback(&self) {\n    // forward call to the "logic" contract which actually executes the call\n}\n\n#[ink::scale_derive(Decode)]\npub enum ProxyMessage {\n    UpgradeContract(Hash),\n}\n\n/// One other message allowed to handle messages.\n/// Fails to compile unless `@` is used as the selector.\n#[ink(message, selector = @)]\npub fn handler(&self, msg: ProxyMessage) {\n  match msg {\n    ProxyMessage(hash) => { }\n  }\n}\n\n/// An additional message. Fails to compile when uncommented.\n// #[ink(message)]\n// pub fn additional_message(&self, msg: ProxyMessage) {\n//    match msg {\n//        ProxyMessage(hash) => ...\n//    }\n// }\n'})}),"\n",(0,s.jsx)(n.h3,{id:"events-20",children:"Events 2.0"}),"\n",(0,s.jsxs)(n.p,{children:["In prior ink! versions, events were defined inside the ",(0,s.jsx)(n.code,{children:"#[ink::contract]"})," macro.\nWith ink! 5.0 we decouple events from the ",(0,s.jsx)(n.code,{children:"#[ink::contract]"})," macro,\nallowing events to be shared between contracts.\nWe've updated ",(0,s.jsx)(n.a,{href:"/docs/v5/basics/events",children:"the Events documentation page"})," accordingly."]}),"\n",(0,s.jsxs)(n.p,{children:["The syntax of defining events within the main ",(0,s.jsx)(n.code,{children:"#[ink::contract]"})," macro will continue to work,\nno code changes in existing contracts are required to update to the new syntax."]}),"\n",(0,s.jsxs)(n.admonition,{type:"caution",children:[(0,s.jsxs)(n.p,{children:["The topic calculation changed in general, so also for events that are declared inside the\n",(0,s.jsx)(n.code,{children:"#[ink::contract]"})," macro!"]}),(0,s.jsx)(n.p,{children:"This is a breaking change for any client code which uses topics to filter events."}),(0,s.jsxs)(n.p,{children:["Please see ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1827",children:"#1827"})," for details."]})]}),"\n",(0,s.jsx)(n.h4,{id:"custom-signature-topics",children:"Custom signature topics"}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/2031",children:"#2031"})," we introduced an\noptional attribute ",(0,s.jsx)(n.code,{children:"signature_topic"})," to the ",(0,s.jsx)(n.code,{children:"#[ink::event]"})," and ",(0,s.jsx)(n.code,{children:"#[ink(event)]"})," macros.\nIt can be used to specify the signature topic for a specific event manually, instead of the\nautomatic topic calculation."]}),"\n",(0,s.jsx)(n.h3,{id:"no-more-unchecked-arithmetic",children:"No more unchecked arithmetic"}),"\n",(0,s.jsx)(n.p,{children:"Unchecked arithmetic operations in a contract are no longer supported for arithmetic\nsafety reasons. Compiling a contract that contains those will fail gracefully."}),"\n",(0,s.jsxs)(n.p,{children:['If you haven\'t already done, you now need to handle overflows that could occur.\nRust supports different possibilities of doing so (saturating, "wrap around",\nand unchecked arithmetic operations) .\nSee ',(0,s.jsx)(n.a,{href:"https://doc.rust-lang.org/book/ch03-02-data-types.html#scalar-types",children:"this"})," section\nof the Rust Programming Language for a thorough explanation on how to do safe arithmetic\noperations in Rust."]}),"\n",(0,s.jsxs)(n.p,{children:["This change was introduced in ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1831",children:"#1831"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"fail-when-decoding-from-storage-and-not-all-bytes-consumed",children:"Fail when decoding from storage and not all bytes consumed"}),"\n",(0,s.jsx)(n.p,{children:"If a contract previously relied on successful decoding which does not consume all bytes,\nthen recompiling with a version of ink! which includes this change will cause that contract\nto trap at runtime when attempting to decode."}),"\n",(0,s.jsxs)(n.p,{children:["A simple example would be if a storage cell contains some bytes which were in the first place\nan encoded ",(0,s.jsx)(n.code,{children:"u32"}),". If the contract attempts to decode those into a ",(0,s.jsx)(n.code,{children:"u8"}),"\nthis would previously have succeeded, now the contract would trap."]}),"\n",(0,s.jsx)(n.p,{children:"Here's a code example of behavior that previously worked for ink! 4.x, but\nwould error now:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'let key = 0u32;\nlet value = [0x42; 32];\nink::env::set_contract_storage(&key, &value);\n\n// Only attempt to read the first byte (the `u8`) of the storage value data\nlet _loaded_value: Option<u8> = ink::env::get_contract_storage(&key)\n    .map_err(|e| format!("get_contract_storage failed: {:?}", e))?;\n'})}),"\n",(0,s.jsxs)(n.p,{children:["We introduced this change in ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1897",children:"#1897"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"ink_e2e-api-changes",children:"[ink_e2e] API Changes"}),"\n",(0,s.jsx)(n.h4,{id:"builder-api",children:"Builder API"}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1917",children:"#1917"})," we reworked the E2E API with\na builder API.\n",(0,s.jsx)(n.code,{children:"instantiate"}),", ",(0,s.jsx)(n.code,{children:"call"})," and ",(0,s.jsx)(n.code,{children:"upload"})," will now return a builder instance. You can\nspecify optional arguments with builder methods, and submit the call for on-chain\nexecution with the ",(0,s.jsx)(n.code,{children:".submit()"})," method, or dry-run it with ",(0,s.jsx)(n.code,{children:"dry_run()"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'let contract = client\n    .instantiate("flipper", &ink_e2e::alice(), &mut constructor)\n    .submit()\n    .await\n    .expect("instantiate failed");\nlet mut call_builder = contract.call_builder::<Flipper>();\n\nlet get = call_builder.get();\nlet get_res = client.call(&ink_e2e::bob(), &get).dry_run().await;\nassert!(matches!(get_res.return_value(), false));\n'})}),"\n",(0,s.jsx)(n.h4,{id:"extra-gas-margin",children:"Extra gas margin"}),"\n",(0,s.jsxs)(n.p,{children:["As part of ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1917",children:"#1917"})," we added the possibility\nto specify a gas margin (in percentage) as part of the on-chain call."]}),"\n",(0,s.jsx)(n.p,{children:"There are cases when gas estimates may not necessarily be accurate enough due to the complexity\nof the smart contract logic that adds additional overhead and gas consumption.\nTherefore, it is helpful to allow to specify an extra portion of the gas to be added to the\nlimit (i.e. 5%, 10%)."}),"\n",(0,s.jsxs)(n.p,{children:["The method ",(0,s.jsx)(n.code,{children:".extra_gas_portion(margin: u64)"})," method is part of the builder API:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.rs/ink_e2e/5.0.0/ink_e2e/struct.InstantiateBuilder.html#method.extra_gas_portion",children:(0,s.jsx)(n.code,{children:"ink_e2e::InstantiateBuilder::extra_gas_portion"})})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.rs/ink_e2e/5.0.0/ink_e2e/struct.CallBuilder.html#method.extra_gas_portion",children:(0,s.jsx)(n.code,{children:"ink_e2e::CallBuilder::extra_gas_portion"})})}),"\n"]}),"\n",(0,s.jsxs)(n.h4,{id:"improved-call-api",children:["Improved ",(0,s.jsx)(n.code,{children:"call()"})," API"]}),"\n",(0,s.jsxs)(n.p,{children:["We removed the ",(0,s.jsx)(n.code,{children:"build_message()"})," function with its unhandy callback."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"// Previously\nlet first_insert = ink_e2e::build_message::<MappingsRef>(contract_id)\n    .call(|contract| contract.insert_balance(1_000));\n\n// Now\nlet first_insert = ink_e2e::build_message::<MappingsRef>(contract_id)\n    .call().insert_balance(1_000));\n"})}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1782",children:"#1782"})," for more details."]}),"\n",(0,s.jsxs)(n.h4,{id:"removed-additional_contracts-parameter",children:["Removed ",(0,s.jsx)(n.code,{children:"additional_contracts"})," parameter"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"additional_contracts"})," parameter which is part of ",(0,s.jsx)(n.code,{children:"#[ink_e2e:test]"})," has been removed in ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/2098",children:"#2098"}),".\nThis information is now implied from the contract's manifest.\nSimply, add the other contract as dependency with the ",(0,s.jsx)(n.code,{children:"ink-as-a-dependency"})," feature enabled.\nThe test will detect the contract and build it as part of the test."]}),"\n",(0,s.jsx)(n.h4,{id:""}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/2076",children:"#2076"}),", we've added a new\n",(0,s.jsx)(n.a,{href:"https://docs.rs/ink_e2e/5.0.0/ink_e2e/trait.ContractsBackend.html#method.remove_code",children:(0,s.jsx)(n.code,{children:"remove_code"})}),"\nfunction to the E2E API:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:'let contract = client\n    .remove_code(&ink_e2e::alice(), code_hash)\n    // Submit the call for on-chain execution.\n    .submit()\n    .await\n    .expect("remove failed");\n'})}),"\n",(0,s.jsxs)(n.h3,{id:"new-data-structure-storagevec",children:["New Data Structure: ",(0,s.jsx)(n.code,{children:"StorageVec"})]}),"\n",(0,s.jsxs)(n.p,{children:["We've added a ",(0,s.jsx)(n.code,{children:"Vec"}),"-like data structure, built on top of Mapping."]}),"\n",(0,s.jsxs)(n.p,{children:["This allows to retrieve elements from a vector and grow it without\nhaving to load and push all elements.\nFor ",(0,s.jsx)(n.code,{children:"Vec"}),", the cost of reading or writing a single element grows linearly corresponding\nto the number of elements in the vector (its length). Additionally, the maximum capacity\nof the whole vector is limited by the size of ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/blob/master/ARCHITECTURE.md#communication-with-the-pallet",children:"ink!'s static buffer"}),"\nused during ABI encoding and decoding (default 16 KiB).\n",(0,s.jsx)(n.code,{children:"StorageVec"})," on the other hand allows to access each element individually."]}),"\n",(0,s.jsxs)(n.p,{children:["With a ",(0,s.jsx)(n.code,{children:"Vec"})," it's possible to e.g. introduce a security issue in your contract\nwhere an attacker can fill the ",(0,s.jsx)(n.code,{children:"Vec"}),", making it very costly for other users to\naccess it or write to it."]}),"\n",(0,s.jsxs)(n.p,{children:["You can find verbatim documentation on ",(0,s.jsx)(n.code,{children:"StorageVec"})," ",(0,s.jsx)(n.a,{href:"/docs/v5/datastructures/storagevec",children:"here"}),".\nThe page explains when to use ",(0,s.jsx)(n.code,{children:"StorageVec"})," and when not.\nThe Rust docs can be found ",(0,s.jsx)(n.a,{href:"https://docs.rs/ink/5.0.0/ink/storage/struct.StorageVec.html",children:"here"}),"."]}),"\n",(0,s.jsxs)(n.h3,{id:"fallible-methods-for-lazy-mapping-storagevec",children:["Fallible methods for ",(0,s.jsx)(n.code,{children:"Lazy"}),", ",(0,s.jsx)(n.code,{children:"Mapping"}),", ",(0,s.jsx)(n.code,{children:"StorageVec"})]}),"\n",(0,s.jsxs)(n.p,{children:["In ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1910",children:"#1910"})," we added ",(0,s.jsx)(n.code,{children:"try_*"})," methods for\nreading and writing ",(0,s.jsx)(n.code,{children:"Lazy"})," and ",(0,s.jsx)(n.code,{children:"Mapping"})," values to and from storage.\nThe try methods correspond to ",(0,s.jsx)(n.code,{children:"Mapping::{insert, get, take}"}),", ",(0,s.jsx)(n.code,{children:"Lazy::{set, get}"}),".\nFor ",(0,s.jsx)(n.code,{children:"StorageVec::{peek, get, set, pop, push}"})," we added ",(0,s.jsx)(n.code,{children:"try_*"})," methods in\n",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1995",children:"#1995"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Please see the individual Rust docs for these new methods:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.rs/ink/5.0.0/ink/storage/struct.StorageVec.html",children:(0,s.jsx)(n.code,{children:"StorageVec"})})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.rs/ink/5.0.0/ink/storage/struct.Lazy.html",children:(0,s.jsx)(n.code,{children:"Lazy"})})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://docs.rs/ink/5.0.0/ink/storage/struct.Mapping.html",children:(0,s.jsx)(n.code,{children:"Mapping"})}),". For ",(0,s.jsx)(n.code,{children:"Mapping"}),", the encoded size of the key is also accounted for."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["You should use the ",(0,s.jsx)(n.code,{children:"try_*"})," methods for dynamically sized values, unless you made sure\notherwise they will fit into the static buffer. The ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/blob/master/ARCHITECTURE.md#communication-with-the-pallet",children:"static buffer in ink!"}),"\nis 16 kB by default."]}),"\n",(0,s.jsxs)(n.p,{children:["We added a lint to ",(0,s.jsx)(n.code,{children:"cargo-contract"})," 4.0 that will detect\npotentially unsafe uses of methods for which there are safer alternatives:\n",(0,s.jsx)(n.a,{href:"/docs/v5/linter/rules/non_fallible_api",children:(0,s.jsx)(n.code,{children:"non_fallible_api"})}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"chain-extension-api-changed--support-for-multiple-chain-extensions",children:"Chain Extension API changed + Support for multiple chain extensions"}),"\n",(0,s.jsxs)(n.p,{children:["With ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1958",children:"#1958"})," we added support for interacting with\nmultiple chain extensions from ink!. This is a breaking change."]}),"\n",(0,s.jsx)(n.p,{children:"You can now e.g. have a contract that utilizes a PSP22 chain extension together with one\nfor random numbers."}),"\n",(0,s.jsx)(n.p,{children:"The syntax for chain extension functions changed slightly:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",children:"-#[ink(extension = 0xfecb)]\n+#[ink(function = 0xfecb)]\nfn foo() {}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The argument type changed from ",(0,s.jsx)(n.code,{children:"u32"})," to ",(0,s.jsx)(n.code,{children:"u16"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",children:"-/// `#[ink(extension = N: u32)]`\n-Extension,\n+/// `#[ink(function = N: u16)]`\n+Function,\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The top level macro ",(0,s.jsx)(n.code,{children:"#[ink::chain_extension]"})," now ",(0,s.jsx)(n.em,{children:"requires"})," an ",(0,s.jsx)(n.code,{children:"(extension = N: u16)"})," argument to support multiple chain extensions.\nIf you are using only one extension, the ID can be any ",(0,s.jsx)(n.code,{children:"u16"})," number,\notherwise please consult the ",(0,s.jsxs)(n.a,{href:"/docs/v5/macros-attributes/chain-extension",children:[(0,s.jsx)(n.code,{children:"#[ink::chain_extension]"})," macro documentation"]})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",children:"-#[ink::chain_extension]\n+#[ink::chain_extension(extension = 1)]\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["If the chain extension was not used in a tuple in the runtime configuration,\n",(0,s.jsx)(n.code,{children:"extension = N: u16"})," can take any ",(0,s.jsx)(n.code,{children:"u16"})," number."]})}),"\n",(0,s.jsxs)(n.p,{children:["A migration in most cases should just be to rename ",(0,s.jsx)(n.code,{children:"#[ink(extension = \u2026)]"})," to\n",(0,s.jsx)(n.code,{children:"#[ink(function = \u2026)]"}),", and specifying ",(0,s.jsx)(n.code,{children:"extension"})," argument in top level macro."]}),"\n",(0,s.jsxs)(n.p,{children:["We added an example contract that illustrates the usage of multiple chain extensions\nin one contract:\n",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink-examples/tree/main/combined-extension",children:(0,s.jsx)(n.code,{children:"combined-extension"})}),"."]}),"\n",(0,s.jsxs)(n.h3,{id:"call-and-instantiate-v2",children:[(0,s.jsx)(n.code,{children:"call"})," and ",(0,s.jsx)(n.code,{children:"instantiate"})," v2"]}),"\n",(0,s.jsxs)(n.p,{children:["The functions to instantiate and call other contracts got an upgrade in the\n",(0,s.jsx)(n.code,{children:"polkadot-v1.8.0"})," release (in the ",(0,s.jsx)(n.a,{href:"https://github.com/paritytech/polkadot-sdk/commit/d250a6e4270a77f28e2737a4faa3fb78c8ea7a85",children:(0,s.jsx)(n.code,{children:"d250a6"})})," commit),\nThe new v2 of them allows passing both ",(0,s.jsx)(n.code,{children:"Weight"})," parts (",(0,s.jsx)(n.code,{children:"ref_time_limit"})," and ",(0,s.jsx)(n.code,{children:"proof_size_limit"}),"),\nas well as the ",(0,s.jsx)(n.code,{children:"storage_deposit_limit"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["The previous v1 ",(0,s.jsx)(n.code,{children:"call"})," and ",(0,s.jsx)(n.code,{children:"instantiate"})," functions only provided a single ",(0,s.jsx)(n.code,{children:"gas_limit"})," parameter,\nwhich was used as the value for ",(0,s.jsx)(n.code,{children:"ref_time_limit"}),".\nYou can still use these ",(0,s.jsx)(n.code,{children:"v1"})," versions.\nFor ",(0,s.jsx)(n.code,{children:"call"})," on a call builder obtained through\n",(0,s.jsx)(n.a,{href:"https://docs.rs/ink_env/5.0.0/ink_env/call/fn.build_call.html",children:(0,s.jsx)(n.code,{children:"build_call"})}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"call_builder\n  .call_v1()\n  .gas_limit(ref_time_limit)\n  .invoke();\n"})}),"\n",(0,s.jsxs)(n.p,{children:["For ",(0,s.jsx)(n.code,{children:"instantiate"})," on ",(0,s.jsx)(n.a,{href:"https://docs.rs/ink_env/5.0.0/ink_env/call/fn.build_create.html",children:(0,s.jsx)(n.code,{children:"build_create"})}),":"]}),"\n",(0,s.jsxs)(n.p,{children:["The new ",(0,s.jsx)(n.code,{children:"v2"})," parameters can be set like so:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"call_builder // or `create_builder`\n  .ref_time_limit(ref_time_limit)\n  .proof_size_limit(proof_size_limit)\n  .storage_deposit_limit(storage_deposit_limit)\n  .invoke();\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can find out if a chain supports the new ",(0,s.jsx)(n.code,{children:"v2"})," functions for call/instantiate by\nquerying the ",(0,s.jsx)(n.code,{children:"contracts::apiVersion"})," constant. It has to be ",(0,s.jsx)(n.code,{children:"1"}),".\nYou can use the ",(0,s.jsx)(n.a,{href:"https://polkadot.js.org/apps/",children:"polakdot.js app"})," to do this:\nDeveloper \xbb Chain State \xbb Constants \xbb ",(0,s.jsx)(n.code,{children:"contracts"})," \xbb ",(0,s.jsx)(n.code,{children:"apiVersion"})," \xbb Click on the ",(0,s.jsx)(n.code,{children:"+"})," on the right."]}),"\n",(0,s.jsx)("img",{src:(0,c.Ay)("/img/api-version-1.png")}),"\n",(0,s.jsxs)(n.p,{children:["At the time of the ink! v5 release (March 2024) no parachain with ink! support\nhad upgraded to ",(0,s.jsx)(n.code,{children:"polkadot-v1.8.0"})," yet."]}),"\n",(0,s.jsxs)(n.p,{children:["Please note that if you are using trait definitions for cross-contract calls,\ndirect calls from the ",(0,s.jsx)(n.code,{children:"contract_ref!"})," macro are only supported with the ",(0,s.jsx)(n.code,{children:"call_v2"}),".\nOtherwise, you need to get the ",(0,s.jsx)(n.code,{children:"CallBuilder"})," from the structure\nand build the call manually."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"type Erc20Wrapper = contract_ref!(Erc20);\nlet erc20: Erc20Wrapper = new_erc20.into();\nlet erc20_builder = erc20.call();\nerc20_builder.total_supply().call_v1().invoke()\n"})}),"\n",(0,s.jsx)(n.h3,{id:"metadata-changes",children:"Metadata Changes"}),"\n",(0,s.jsx)(n.h4,{id:"events-20-1",children:"Events 2.0"}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1827",children:"#1827"})," for the full details.\nTwo fields werere added to the objects in the ",(0,s.jsx)(n.code,{children:"events"})," array:\n",(0,s.jsx)(n.code,{children:"module_path"})," and ",(0,s.jsx)(n.code,{children:"signature_topic"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Previously the order of the events in the ",(0,s.jsx)(n.code,{children:"events"})," array was significant (i.e. the first\none had an implied index of ",(0,s.jsx)(n.code,{children:"0"}),"), and this index could be used to determine which event\nto decode.\nNow that is replaced by the ",(0,s.jsx)(n.code,{children:"signature_topic"}),", and the order of the events in the metadata\nno longer has any significance."]}),"\n",(0,s.jsxs)(n.p,{children:['See the section "',(0,s.jsx)(n.a,{href:"#events-20",children:"Events 2.0"}),'" on this page for more info.']}),"\n",(0,s.jsx)(n.p,{children:"ink! 4.0:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'   "events": [\n      {\n        "args": [ ... ],\n        "docs": [ ... ],\n        "label": "Transfer"\n      },\n      ...\n  ]\n'})}),"\n",(0,s.jsx)(n.p,{children:"ink! 5.0:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",children:'    "events": [\n      {\n        "args": [ ... ],\n        "docs": [ ... ],\n        "label": "...",\n+       "module_path": "erc20::erc20",\n+       "signature_topic": "0xb5b61a3e6a21a16be4f044b517c28ac692492f73c5bfd3f60178ad98c767f4cb"\n      },\n      ...\n  ]\n'})}),"\n",(0,s.jsxs)(n.h4,{id:"new-field-staticbuffersize",children:["New field: ",(0,s.jsx)(n.code,{children:"staticBufferSize"})]}),"\n",(0,s.jsxs)(n.p,{children:["With ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1880",children:"#1880"})," we added a ",(0,s.jsx)(n.code,{children:'"staticBufferSize"'})," field to\nthe metadata file. The unit is bytes."]}),"\n",(0,s.jsxs)(n.p,{children:['See the section "',(0,s.jsx)(n.a,{href:"#buffer-size-can-be-customized",children:"Buffer size can be customized"}),'" on this page for\nmore info.']}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",children:'      "maxEventTopics": 4,\n+     "staticBufferSize": 16384,\n      "timestamp": { ... }\n'})}),"\n",(0,s.jsx)(n.h4,{id:"metadata-storage-keys-encoding-change",children:"Metadata storage keys encoding change"}),"\n",(0,s.jsx)(n.p,{children:"Storage keys used to access storage data are SCALE encoded. Previously,\nthe contract metadata used big endian encoding to represent storage keys.\nWith the ink! 5.0 release, these encoding formats have been aligned,\nand SCALE encoding (little endian) is now used for the metadata storage keys.\nThis is a breaking change, and client tools that use the storage keys from contract\nmetadata will need to adapt accordingly."}),"\n",(0,s.jsxs)(n.p,{children:["Please see: ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/2048",children:"#2048"})," for details."]}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-diff",children:'    "storage": {\n        "root": {\n        "layout": {\n            "struct": {\n            "fields": [\n                {\n                "layout": {\n                    "leaf": {\n-                   "key": "0x00000159",\n+                   "key": "0x59010000",\n                    "ty": 0\n                    }\n                },\n                "name": "value"\n                }\n            ],\n            "name": "Flipper"\n            }\n        },\n-       "root_key": "0x00000159",\n+       "root_key": "0x59010000",\n        "ty": 1\n        }\n    },\n'})}),"\n",(0,s.jsx)(n.h2,{id:"interesting-new-features",children:"Interesting New Features"}),"\n",(0,s.jsx)(n.h3,{id:"end-to-end-testing-with-a-chain-snapshot",children:"End-To-End testing with a chain snapshot"}),"\n",(0,s.jsx)(n.p,{children:"With ink! 5.0 we introduce the possibility of running your tests against the\nfork (i.e. snapshot) of a live chain."}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"/docs/v5/basics/contract-testing/chain-snapshot",children:"this page"})," in our documentation for details."]}),"\n",(0,s.jsx)(n.h3,{id:"new-lints",children:"New lints"}),"\n",(0,s.jsx)(n.p,{children:"The new lints are:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/v5/linter/rules/no_main",children:(0,s.jsx)(n.code,{children:"no_main"})}),": enforces ",(0,s.jsx)(n.code,{children:"no_main"})," for  contracts."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/v5/linter/rules/primitive_topic",children:(0,s.jsx)(n.code,{children:"primitive_topic"})}),": no number types are allowed as event topics."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/v5/linter/rules/storage_never_freed",children:(0,s.jsx)(n.code,{children:"storage_never_freed"})}),": what is written into storage can be removed again."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/v5/linter/rules/strict_balance_equality",children:(0,s.jsx)(n.code,{children:"strict_balance_equality"})}),": detects usage of strict balance equality checks, a common smart contract vulnerability."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/v5/linter/rules/non_fallible_api",children:(0,s.jsx)(n.code,{children:"non_fallible_api"})}),": detects the usage of potentially unsafe methods for which there are safer alternatives."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["With ",(0,s.jsx)(n.code,{children:"cargo-contract"})," 4.0 we added a couple new lints for common smart contract issues\nand best practices.\nYou can run the linter via ",(0,s.jsx)(n.code,{children:"cargo contract build --lint"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Details on each lint can be found ",(0,s.jsx)(n.a,{href:"/docs/v5/linter/overview",children:"here"}),"."]}),"\n",(0,s.jsxs)(n.h3,{id:"new-cargo-contract-commands",children:["New ",(0,s.jsx)(n.code,{children:"cargo-contract"})," commands"]}),"\n",(0,s.jsxs)(n.p,{children:["We added a bunch of helpful new commands to ",(0,s.jsx)(n.code,{children:"cargo-contract"})," 4.0.\nFor all these commands you can also supply the ",(0,s.jsx)(n.code,{children:"--help"})," cli flag to get more\ninfo (e.g. ",(0,s.jsx)(n.code,{children:"cargo contract storage --help"}),")."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"cargo contract verify"}),": contract verification (",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/cargo-contract/pull/1404",children:"#1404"}),", ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/cargo-contract/pull/1306",children:"#1306"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"cargo contract info"})," now outputs the language of the deployed contract, using a heuristic (",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/cargo-contract/pull/1329",children:"#1329"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"cargo contract info --binary"}),": outputs the on-chain Wasm of the contract (",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/cargo-contract/pull/1311/",children:"#1311"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"cargo contract info --all"}),": displays all addresses of deployed contracts on a particular chain (",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/cargo-contract/pull/1319",children:"#1319"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"cargo contract storage"}),": displays the storage of an on-chain contract (",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/cargo-contract/pull/1395",children:"#1395"}),", ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/cargo-contract/pull/1414",children:"#1414"}),")"]}),"\n"]}),"\n",(0,s.jsx)("img",{src:(0,c.Ay)("/img/cargo-contract-storage.png")}),"\n",(0,s.jsx)("br",{}),"\n",(0,s.jsx)("img",{src:(0,c.Ay)("/img/cargo-contract-info.png")}),"\n",(0,s.jsx)(n.h3,{id:"alternative-off-chain-e2e-testing-backend-support-drink",children:"Alternative off-chain E2E testing backend support: DRink!"}),"\n",(0,s.jsx)(n.p,{children:"DRink! is a toolbox for ink! developers that allows for testing your contracts\nwithout any running node."}),"\n",(0,s.jsx)(n.p,{children:"It has a number of features that are pretty great:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["deploy and call your contracts synchronously, ",(0,s.jsx)(n.em,{children:"without any delays"})," related to block production or networking."]}),"\n",(0,s.jsx)(n.li,{children:"enhanced debugging and call tracing."}),"\n",(0,s.jsxs)(n.li,{children:["supports ",(0,s.jsx)(n.em,{children:"arbitrary runtime"})," configurations, including custom chain extensions and runtime calls."]}),"\n",(0,s.jsx)(n.li,{children:"full control over runtime state, including block number, timestamp, etc."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["See the ",(0,s.jsx)(n.a,{href:"https://github.com/inkdevhub/drink",children:"DRink!"})," page for more details."]}),"\n",(0,s.jsx)(n.h3,{id:"contract-verification",children:"Contract Verification"}),"\n",(0,s.jsxs)(n.p,{children:["We added a bunch of helpful documentation and ",(0,s.jsx)(n.code,{children:"cargo-contract"})," commands for\ncontract verification. ",(0,s.jsx)(n.a,{href:"/docs/v5/basics/verification/contract-verification",children:"Read more here"}),"."]}),"\n",(0,s.jsxs)(n.h3,{id:"we-improved-the-contract-example-illustrating-upgradeable-contracts-via-delegate_call",children:["We improved the contract example illustrating upgradeable contracts via ",(0,s.jsx)(n.code,{children:"delegate_call"})]}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink-examples/tree/main/upgradeable-contracts",children:"here"}),"\nfor the contract example."]}),"\n",(0,s.jsxs)(n.h3,{id:"upgradeable-contracts-delegate_dependency",children:["Upgradeable Contracts: ",(0,s.jsx)(n.code,{children:"delegate_dependency"})]}),"\n",(0,s.jsx)(n.p,{children:"We've added support for two new host functions:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"lock_delegate_dependency"}),": prevents the code at the given code hash from being removed."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"unlock_delegate_dependency"}),": releases the lock on preventing the code from being removed\nfrom the current contract."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Having a delegate dependency allows contracts to safely delegate to another ",(0,s.jsx)(n.code,{children:"code_hash"})," with\nthe guarantee that it cannot be deleted."]}),"\n",(0,s.jsxs)(n.p,{children:["We've updated the ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink-examples/tree/main/upgradeable-contracts#delegator",children:(0,s.jsx)(n.code,{children:"upgradeable-contracts/delegator"})}),"\nexample to demonstrate these new calls.\nFor that purpose we've also added a ",(0,s.jsx)(n.a,{href:"https://docs.rs/ink_e2e/5.0.0/ink_e2e/trait.ContractsBackend.html#method.remove_code",children:(0,s.jsx)(n.code,{children:"remove_code"})}),"\nfunction to the E2E API."]}),"\n",(0,s.jsxs)(n.p,{children:["These two functions are only available from ",(0,s.jsx)(n.code,{children:"polkadot-1.8.0"})," on.\nYou can find out if a chain supports these new functions by\nquerying the ",(0,s.jsx)(n.code,{children:"contracts::apiVersion"})," constant. It has to be ",(0,s.jsx)(n.code,{children:"2"}),".\nYou can use the ",(0,s.jsx)(n.a,{href:"https://polkadot.js.org/apps/",children:"polakdot.js app"})," to do this:\nDeveloper \xbb Chain State \xbb Constants \xbb ",(0,s.jsx)(n.code,{children:"contracts"})," \xbb ",(0,s.jsx)(n.code,{children:"apiVersion"})," \xbb Click on the ",(0,s.jsx)(n.code,{children:"+"})," on the right."]}),"\n",(0,s.jsx)("img",{src:(0,c.Ay)("/img/api-version-2.png")}),"\n",(0,s.jsxs)(n.p,{children:["At the time of the ink! v5 release (March 2024) no parachain with ink! support\nhad upgraded to ",(0,s.jsx)(n.code,{children:"polkadot-v1.8.0"})," yet."]}),"\n",(0,s.jsxs)(n.h3,{id:"we-made-set_code_hash-generic",children:["We made ",(0,s.jsx)(n.code,{children:"set_code_hash"})," generic"]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"self.env().set_code_hash()"})," method now accepts the ",(0,s.jsx)(n.code,{children:"Hash"})," environment type instead\nof a concrete ",(0,s.jsx)(n.code,{children:"[u8; 32]"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-rust",children:"// Previously\npub fn set_code(&mut self, code_hash: [u8; 32]) {\n    ink::env::set_code_hash(&code_hash).unwrap_or_else(|err| {});\n}\n\n// Now\npub fn set_code(&mut self, code_hash: Hash) {\n    self.env().set_code_hash(&code_hash).unwrap_or_else(|err| {});\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["More details in ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1906",children:"#1906"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"buffer-size-can-be-customized",children:"Buffer size can be customized"}),"\n",(0,s.jsxs)(n.p,{children:["With ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1869",children:"#1869"})," we added a possibility\nof setting a custom static buffer size for ink! to use."]}),"\n",(0,s.jsxs)(n.p,{children:["ink! uses a static buffer for interacting with pallet-contracts, i.e. to move data\nbetween ",(0,s.jsx)(n.code,{children:"pallet-contracts"})," and a smart contract. The advantage of a static buffer\nis that no gas-expensive heap allocations are necessary, all allocations are done\nusing simple pointer arithmetic."]}),"\n",(0,s.jsxs)(n.p,{children:["The default static buffer size is 16 kB, which is enough for on-chain smart\ncontracts. However, the ",(0,s.jsx)(n.a,{href:"https://phala.network/",children:"Phala Network"})," parachain on Polkadot\nallows the deployment of ink! contracts off-chain. Hence, for their chain certain high\ncomputation contracts might require a larger buffer size."]}),"\n",(0,s.jsxs)(n.h3,{id:"stabilized-call_runtime",children:["Stabilized ",(0,s.jsx)(n.code,{children:"call_runtime"})]}),"\n",(0,s.jsxs)(n.p,{children:["We stabilized ",(0,s.jsx)(n.code,{children:"call_runtime"})," in ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink/pull/1749",children:"#1749"}),".\nIt can be used to call a runtime dispatchable from an ink! contract."]}),"\n",(0,s.jsxs)(n.p,{children:["You can find a contract example and a comparison with chain extensions\n",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink-examples/tree/main/call-runtime",children:"here"}),".\nWe've added an example of how to end-to-end test\n",(0,s.jsx)(n.code,{children:"call_runtime"})," ",(0,s.jsx)(n.a,{href:"https://github.com/use-ink/ink-examples/tree/main/e2e-call-runtime",children:"here"}),"."]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},36048:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/migration-4.x-to-5.0-c8ff24289a1bd0d686f54d8f8b0e170b.svg"},28453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>r});var i=t(96540);const s={},a=i.createContext(s);function c(e){const n=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);