"use strict";(self.webpackChunkink_docs=self.webpackChunkink_docs||[]).push([[7099],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>k});var r=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},u="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(n),d=o,k=u["".concat(l,".").concat(d)]||u[d]||h[d]||a;return n?r.createElement(k,i(i({ref:t},p),{},{components:n})):r.createElement(k,i({ref:t},p))}));function k(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:o,i[1]=s;for(var c=2;c<a;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},81015:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var r=n(87462),o=(n(67294),n(3905));const a={title:"Testing with Chain Snapshot",hide_title:!0,slug:"/basics/contract-testing/chain-snapshot"},i=void 0,s={unversionedId:"testing/testing-with-live-state",id:"version-5.x/testing/testing-with-live-state",title:"Testing with Chain Snapshot",description:"On this page we explain how to do test ink! contracts with the",source:"@site/versioned_docs/version-5.x/testing/testing-with-live-state.md",sourceDirName:"testing",slug:"/basics/contract-testing/chain-snapshot",permalink:"/5.x/basics/contract-testing/chain-snapshot",draft:!1,editUrl:"https://github.com/paritytech/ink-docs/edit/master/versioned_docs/version-5.x/testing/testing-with-live-state.md",tags:[],version:"5.x",frontMatter:{title:"Testing with Chain Snapshot",hide_title:!0,slug:"/basics/contract-testing/chain-snapshot"},sidebar:"reference",previous:{title:"End-to-End (E2E) Tests",permalink:"/5.x/basics/contract-testing/end-to-end-e2e-testing"},next:{title:"Debugging",permalink:"/5.x/basics/contract-debugging"}},l={},c=[{value:"General Concept",id:"general-concept",level:2},{value:"Setup Chopsticks",id:"setup-chopsticks",level:3},{value:"Run ink! e2e tests",id:"run-ink-e2e-tests",level:3}],p={toc:c},u="wrapper";function h(e){let{components:t,...n}=e;return(0,o.kt)(u,(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("img",{src:"/img/title/testing1.svg",className:"titlePic"}),(0,o.kt)("h1",{id:"test-end-to-end-with-live-chain-state"},"Test End-to-End with Live Chain State"),(0,o.kt)("p",null,"On this page we explain how to do test ink! contracts with the\nfork (i.e. snapshot) of a live chain."),(0,o.kt)("p",null,"We'll use the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/AcalaNetwork/chopsticks"},"Chopsticks")," tool for this purpose.\nIn the first section of this page we explain the general concept, using a local\n",(0,o.kt)("inlineCode",{parentName:"p"},"substrate-contracts-node"),' that will play the role of our "live chain".\nIn the second section we explain how to use one of the big production chains.'),(0,o.kt)("h2",{id:"general-concept"},"General Concept"),(0,o.kt)("p",null,"First you need a node that has produced some blocks with state. We'll\nuse ",(0,o.kt)("inlineCode",{parentName:"p"},"substrate-contracts-node")," for this purpose.\n",(0,o.kt)("a",{parentName:"p",href:"/5.x/getting-started/running-substrate/"},"See here")," for how to run it."),(0,o.kt)("p",null,"You should get output similar to:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'$ substrate-contracts-node\n2023-09-26 07:58:28.885  INFO main sc_cli::runner: Substrate Contracts Node    \n2023-09-26 07:58:28.887  INFO main sc_cli::runner: \u270c\ufe0f  version 0.30.0-124c159ba94    \n2023-09-26 07:58:28.887  INFO main sc_cli::runner: \u2764\ufe0f  by Parity Technologies <admin@parity.io>, 2021-2023    \n2023-09-26 07:58:28.887  INFO main sc_cli::runner: \ud83d\udccb Chain specification: Development    \n2023-09-26 07:58:28.887  INFO main sc_cli::runner: \ud83c\udff7  Node name: chilly-desire-6458    \n2023-09-26 07:58:28.887  INFO main sc_cli::runner: \ud83d\udc64 Role: AUTHORITY    \n2023-09-26 07:58:28.887  INFO main sc_cli::runner: \ud83d\udcbe Database: ParityDb at /tmp/substrateoKCAts/chains/dev/paritydb/full    \n2023-09-26 07:58:38.723  INFO main sc_rpc_server: Running JSON-RPC server: addr=127.0.0.1:9944, allowed origins=["*"]  \n')),(0,o.kt)("p",null,"Note that the node is running on port 9944."),(0,o.kt)("p",null,"Next, we'll create some state and produce a bunch of blocks. You can do this by deploying ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/paritytech/ink-examples/tree/main/flipper"},"our\n",(0,o.kt)("inlineCode",{parentName:"a"},"flipper")," example"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"cd ink-examples/flipper/\ncargo build --release\ncargo contract instantiate --suri //Alice --args true -x\n")),(0,o.kt)("p",null,"You can check that the contract exists by querying its state via ",(0,o.kt)("inlineCode",{parentName:"p"},"cargo-contract"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},"$ cargo contract storage --contract 5FgRdaReCLFtwbzYiVd2hoz9P3oERdNy2njnFmUBHu4FYg7s\nIndex | Root Key | Parent | Value                                                                                                            \n0     | 00000000 | root   | Flipper { value: true } \n")),(0,o.kt)("h3",{id:"setup-chopsticks"},"Setup Chopsticks"),(0,o.kt)("p",null,"We will now set up ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/AcalaNetwork/chopsticks"},"Chopsticks"),",\na powerful tool in our ecosystem that allows us to create a parallel reality\nof an existing network."),(0,o.kt)("p",null,"We will run it and have it mirror the ",(0,o.kt)("inlineCode",{parentName:"p"},"substrate-contracts-node")," that is already running\non our machine from the previous step. "),(0,o.kt)("p",null,"Clone chopsticks:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"git clone https://github.com/AcalaNetwork/chopsticks\n")),(0,o.kt)("p",null,"Modify the ",(0,o.kt)("inlineCode",{parentName:"p"},"dev.yml")," config file in the cloned repository (or create one from scratch) :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"endpoint: ws://127.0.0.1:9944\nmock-signature-host: true\nblock: 1\ndb: ./db.sqlite\n")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"In the example above chopsticks will be mirroring up until block 1 from the\n",(0,o.kt)("inlineCode",{parentName:"p"},"substrate-contracts-node"),". For real world use case you would want to use a\ndifferent block number and this is the place where you can configure other\nvariables such as a sudo key. Read the chopsticks docs for more info.")),(0,o.kt)("p",null,"You can either run chopsticks locally by following the instructions here:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/AcalaNetwork/chopsticks#install"},"https://github.com/AcalaNetwork/chopsticks#install"))),(0,o.kt)("p",null,"Or you can run chopsticks using npx:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"npx @acala-network/chopsticks@latest --config=configs/dev.yml\n")),(0,o.kt)("p",null,"You should get output similar to:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"npx @acala-network/chopsticks@latest --config=configs/dev.yml\n[08:22:31.231] INFO (rpc/3037748): Development RPC listening on port 8000\n")),(0,o.kt)("p",null,"The Chopsticks node is running on port 8000.\nIf you now execute the ",(0,o.kt)("inlineCode",{parentName:"p"},"cargo-contract")," storage command against this node, you'll see\nthat the ",(0,o.kt)("inlineCode",{parentName:"p"},"flipper")," contract exists there as well:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"cargo contract storage --contract 5FgRdaReCLFtwbzYiVd2hoz9P3oERdNy2njnFmUBHu4FYg7s --url=ws://localhost:9944\nIndex | Root Key | Parent | Value                                                                                                            \n0     | 00000000 | root   | Flipper { value: true }\n")),(0,o.kt)("p",null,'Recap: We have our "live" ',(0,o.kt)("inlineCode",{parentName:"p"},"substrate-contracts-node")," running on port 9944\nand our test node with the branched state running on port 8000.\nYou can now submit transactions to the node on port 8000, without affecting\nthe node on port 9944."),(0,o.kt)("h3",{id:"run-ink-e2e-tests"},"Run ink! e2e tests"),(0,o.kt)("p",null,"Next we would like to run some tests against this contract.\nAdd this code to the ",(0,o.kt)("inlineCode",{parentName:"p"},"flipper")," example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-rust"},"TODO\n")),(0,o.kt)("p",null,"Let's now run our flipper integration tests against the Chopsticks node :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"CONTRACTS_NODE_URL=ws://127.0.0.1:8000 cargo test --features e2e-tests\n")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Notice how we use the ",(0,o.kt)("inlineCode",{parentName:"p"},"CONTRACTS_NODE_URL")," environment variable to specify where our\nChopsticks node is running. This is essential.")),(0,o.kt)("p",null,"You will get output similar to the following:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"running 4 tests\ntest flipper::e2e_tests::foobar ... ok\n")),(0,o.kt)("p",null,"Success! We just ran ink! integration tests against live chain state!"))}h.isMDXComponent=!0}}]);